# Ultralytics ðŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Objects365 dataset https://www.objects365.org/ by Megvii
# Example usage: python train.py --data Objects365.yaml
# parent
# â”œâ”€â”€ yolov5
# â””â”€â”€ datasets
#     â””â”€â”€ Objects365  â† downloads here (712 GB = 367G data + 345G zips)

# Train/val/test sets as 1) dir: path/to/imgs, 2) file: path/to/imgs.txt, or 3) list: [path/to/imgs1, path/to/imgs2, ..]
path: ../datasets/Objects365 # dataset root dir
train: images/train # train images (relative to 'path') 1742289 images
val: images/val # val images (relative to 'path') 80000 images
test: # test images (optional)

# Classes
names:
  0: Pessoa
  1: TÃªnis
  2: Cadeira
  3: Outros CalÃ§ados
  4: ChapÃ©u
  5: Carro
  6: LÃ¢mpada
  7: Ã“culos
  8: Garrafa
  9: Mesa
  10: XÃ­cara
  11: IluminaÃ§Ã£o PÃºblica
  12: ArmÃ¡rio/Prateleira
  13: Bolsa/Sacola
  14: Pulseira
  15: Prato
  16: Quadro/Moldura
  17: Capacete
  18: Livro
  19: Luvas
  20: Caixa de Armazenamento
  21: Barco
  22: Sapatos de Couro
  23: Flor
  24: Banco
  25: Vaso de Planta
  26: Tigela/Bacia
  27: Bandeira
  28: Travesseiro
  29: Botas
  30: Vaso
  31: Microfone
  32: Colar
  33: Anel
  34: SUV
  35: TaÃ§a de Vinho
  36: Cinto
  37: Monitor/TV
  38: Mochila
  39: Guarda-chuva
  40: SemÃ¡foro
  41: Alto-falante
  42: RelÃ³gio
  43: Gravata
  44: Lixeira
  45: Chinelos
  46: Bicicleta
  47: Banqueta
  48: Barril/Balde
  49: Van
  50: SofÃ¡
  51: SandÃ¡lias
  52: Cesta
  53: Tambor
  54: Caneta/LÃ¡pis
  55: Ã”nibus
  56: PÃ¡ssaro Selvagem
  57: Salto Alto
  58: Motocicleta
  59: ViolÃ£o
  60: Tapete
  61: Celular
  62: PÃ£o
  63: CÃ¢mera
  64: Enlatado
  65: CaminhÃ£o
  66: Cone de TrÃ¢nsito
  67: Prato Musical
  68: Boia
  69: Toalha
  70: Bicho de PelÃºcia
  71: Vela
  72: Veleiro
  73: Laptop
  74: Toldo
  75: Cama
  76: Torneira
  77: Barraca
  78: Cavalo
  79: Espelho
  80: Tomada
  81: Pia
  82: MaÃ§Ã£
  83: Ar Condicionado
  84: Faca
  85: Taco de HÃ³quei
  86: Remo
  87: Picape
  88: Garfo
  89: Placa de TrÃ¢nsito
  90: BalÃ£o
  91: TripÃ©
  92: Cachorro
  93: Colher
  94: RelÃ³gio
  95: Panela
  96: Vaca
  97: Bolo
  98: Mesa de Jantar
  99: Ovelha
  100: Cabide
  101: Quadro Negro/Branco
  102: Guardanapo
  103: Outros Peixes
  104: Laranja/Tangerina
  105: Artigos de Higiene
  106: Teclado
  107: Tomate
  108: Lanterna
  109: VeÃ­culo de MaquinÃ¡rio
  110: Ventilador
  111: Verduras
  112: Banana
  113: Luva de Baseball
  114: AviÃ£o
  115: Mouse
  116: Trem
  117: AbÃ³bora
  118: Bola de Futebol
  119: Esqui
  120: Bagagem
  121: Criado-mudo
  122: Bule de ChÃ¡
  123: Telefone
  124: Carrinho
  125: Fone de Ouvido
  126: Carro Esportivo
  127: Placa de Pare
  128: Sobremesa
  129: Patinete
  130: Carrinho de BebÃª
  131: Guindaste
  132: Controle Remoto
  133: Geladeira
  134: Forno
  135: LimÃ£o
  136: Pato
  137: Taco de Baseball
  138: CÃ¢mera de VigilÃ¢ncia
  139: Gato
  140: Jarro
  141: BrÃ³colis
  142: Piano
  143: Pizza
  144: Elefante
  145: Skate
  146: Prancha de Surf
  147: Arma
  148: Sapatos de PatinaÃ§Ã£o e Esqui
  149: FogÃ£o a GÃ¡s
  150: Rosquinha
  151: Gravata Borboleta
  152: Cenoura
  153: Vaso SanitÃ¡rio
  154: Pipa
  155: Morango
  156: Outras Bolas
  157: PÃ¡
  158: Pimenta
  159: Gabinete de Computador
  160: Papel HigiÃªnico
  161: Produtos de Limpeza
  162: Pauzinhos
  163: Micro-ondas
  164: Pombo
  165: Bola de Baseball
  166: TÃ¡bua de Corte
  167: Mesa de CafÃ©
  168: Mesa Lateral
  169: Tesoura
  170: Marcador
  171: Torta
  172: Escada
  173: Prancha de Snowboard
  174: Biscoitos
  175: Radiador
  176: Hidrante
  177: Bola de Basquete
  178: Zebra
  179: Uva
  180: Girafa
  181: Batata
  182: LinguiÃ§a
  183: Triciclo
  184: Violino
  185: Ovo
  186: Extintor de IncÃªndio
  187: Doce
  188: CaminhÃ£o de Bombeiros
  189: Sinuca
  190: Conversor
  191: Banheira
  192: Cadeira de Rodas
  193: Taco de Golfe
  194: Pasta
  195: Pepino
  196: Cigarro/Charuto
  197: Pincel
  198: Pera
  199: CaminhÃ£o Pesado
  200: HambÃºrguer
  201: Exaustor
  202: ExtensÃ£o ElÃ©trica
  203: Pegador
  204: Raquete de TÃªnis
  205: Pasta/Arquivo
  206: Futebol Americano
  207: Fone de Ouvido
  208: MÃ¡scara
  209: Chaleira
  210: Bola de TÃªnis
  211: Navio
  212: BalanÃ§o
  213: Cafeteira
  214: Escorregador
  215: Carruagem
  216: Cebola
  217: Vagem
  218: Projetor
  219: Frisbee
  220: MÃ¡quina de Lavar/Secar
  221: Frango
  222: Impressora
  223: Melancia
  224: Saxofone
  225: LenÃ§o
  226: Escova de Dentes
  227: Sorvete
  228: BalÃ£o de Ar Quente
  229: Violoncelo
  230: Batata Frita
  231: BalanÃ§a
  232: TrofÃ©u
  233: Repolho
  234: Cachorro-quente
  235: Liquidificador
  236: PÃªssego
  237: Arroz
  238: Carteira/Bolsa
  239: Bola de VÃ´lei
  240: Cervo
  241: Ganso
  242: Fita
  243: Tablet
  244: CosmÃ©ticos
  245: Trompete
  246: Abacaxi
  247: Bola de Golfe
  248: AmbulÃ¢ncia
  249: ParquÃ­metro
  250: Manga
  251: Chave
  252: ObstÃ¡culo
  253: Vara de Pescar
  254: Medalha
  255: Flauta
  256: Escova
  257: Pinguim
  258: Megafone
  259: Milho
  260: Alface
  261: Alho
  262: Cisne
  263: HelicÃ³ptero
  264: Cebolinha
  265: SanduÃ­che
  266: Nozes
  267: Placa de Limite de Velocidade
  268: FogÃ£o de InduÃ§Ã£o
  269: Vassoura
  270: Trombone
  271: Ameixa
  272: RiquixÃ¡
  273: Peixe Dourado
  274: Kiwi
  275: Roteador/Modem
  276: Carta de PÃ´quer
  277: Torradeira
  278: CamarÃ£o
  279: Sushi
  280: Queijo
  281: Bloco de Notas
  282: Cereja
  283: Alicate
  284: CD
  285: Massa
  286: Martelo
  287: Taco
  288: Abacate
  289: MelÃ£o
  290: Frasco
  291: Cogumelo
  292: Chave de Fenda
  293: SabÃ£o
  294: Flauta Doce
  295: Urso
  296: Berinjela
  297: Apagador
  298: Coco
  299: Fita MÃ©trica/RÃ©gua
  300: Porco
  301: Chuveiro
  302: Globo
  303: Batata Frita
  304: Bife
  305: Placa de Travessia
  306: Grampeador
  307: Camelo
  308: FÃ³rmula 1
  309: RomÃ£
  310: Lava-louÃ§as
  311: Caranguejo
  312: Hoverboard
  313: AlmÃ´ndega
  314: Panela de Arroz
  315: Tuba
  316: Calculadora
  317: MamÃ£o
  318: AntÃ­lope
  319: Papagaio
  320: Foca
  321: Borboleta
  322: Halter
  323: Burro
  324: LeÃ£o
  325: MictÃ³rio
  326: Golfinho
  327: Furadeira ElÃ©trica
  328: Secador de Cabelo
  329: Torta de Ovo
  330: Ãgua-viva
  331: Esteira
  332: Isqueiro
  333: Toranja
  334: Tabuleiro de Jogo
  335: EsfregÃ£o
  336: Rabanete
  337: PÃ£o ChinÃªs
  338: Alvo
  339: FrancÃªs
  340: Rolinho Primavera
  341: Macaco
  342: Coelho
  343: Estojo
  344: Iaque
  345: Repolho Roxo
  346: BinÃ³culo
  347: Aspargo
  348: Barra de Peso
  349: Vieira
  350: MacarrÃ£o
  351: Pente
  352: Bolinho
  353: Ostra
  354: Raquete de TÃªnis de Mesa
  355: Pincel de Maquiagem/Delineador
  356: Motosserra
  357: Borracha
  358: Lagosta
  359: DuriÃ£o
  360: Quiabo
  361: Batom
  362: Espelho de Maquiagem
  363: Curling
  364: TÃªnis de Mesa

# Download script/URL (optional) ---------------------------------------------------------------------------------------
download: |
  from tqdm import tqdm

  from utils.general import Path, check_requirements, download, np, xyxy2xywhn

  check_requirements('pycocotools>=2.0')
  from pycocotools.coco import COCO

  # Make Directories
  dir = Path(yaml['path'])  # dataset root dir
  for p in 'images', 'labels':
      (dir / p).mkdir(parents=True, exist_ok=True)
      for q in 'train', 'val':
          (dir / p / q).mkdir(parents=True, exist_ok=True)

  # Train, Val Splits
  for split, patches in [('train', 50 + 1), ('val', 43 + 1)]:
      print(f"Processing {split} in {patches} patches ...")
      images, labels = dir / 'images' / split, dir / 'labels' / split

      # Download
      url = f"https://dorc.ks3-cn-beijing.ksyun.com/data-set/2020Objects365%E6%95%B0%E6%8D%AE%E9%9B%86/{split}/"
      if split == 'train':
          download([f'{url}zhiyuan_objv2_{split}.tar.gz'], dir=dir, delete=False)  # annotations json
          download([f'{url}patch{i}.tar.gz' for i in range(patches)], dir=images, curl=True, delete=False, threads=8)
      elif split == 'val':
          download([f'{url}zhiyuan_objv2_{split}.json'], dir=dir, delete=False)  # annotations json
          download([f'{url}images/v1/patch{i}.tar.gz' for i in range(15 + 1)], dir=images, curl=True, delete=False, threads=8)
          download([f'{url}images/v2/patch{i}.tar.gz' for i in range(16, patches)], dir=images, curl=True, delete=False, threads=8)

      # Move
      for f in tqdm(images.rglob('*.jpg'), desc=f'Moving {split} images'):
          f.rename(images / f.name)  # move to /images/{split}

      # Labels
      coco = COCO(dir / f'zhiyuan_objv2_{split}.json')
      names = [x["name"] for x in coco.loadCats(coco.getCatIds())]
      for cid, cat in enumerate(names):
          catIds = coco.getCatIds(catNms=[cat])
          imgIds = coco.getImgIds(catIds=catIds)
          for im in tqdm(coco.loadImgs(imgIds), desc=f'Class {cid + 1}/{len(names)} {cat}'):
              width, height = im["width"], im["height"]
              path = Path(im["file_name"])  # image filename
              try:
                  with open(labels / path.with_suffix('.txt').name, 'a') as file:
                      annIds = coco.getAnnIds(imgIds=im["id"], catIds=catIds, iscrowd=False)
                      for a in coco.loadAnns(annIds):
                          x, y, w, h = a['bbox']  # bounding box in xywh (xy top-left corner)
                          xyxy = np.array([x, y, x + w, y + h])[None]  # pixels(1,4)
                          x, y, w, h = xyxy2xywhn(xyxy, w=width, h=height, clip=True)[0]  # normalized and clipped
                          file.write(f"{cid} {x:.5f} {y:.5f} {w:.5f} {h:.5f}\n")
              except Exception as e:
                  print(e)
